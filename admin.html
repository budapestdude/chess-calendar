<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Calendar Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .auth-section input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            width: 300px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
        }
        
        .content-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .events-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .events-table th:hover {
            background: #e9ecef;
        }
        
        .events-table th.sortable:after {
            content: '↕';
            position: absolute;
            right: 10px;
            color: #999;
        }
        
        .events-table th.sort-asc:after {
            content: '↑';
            color: #007bff;
        }
        
        .events-table th.sort-desc:after {
            content: '↓';
            color: #007bff;
        }
        
        .events-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .events-table tr:hover {
            background: #f8f9fa;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .special-badge {
            background: #ffc107;
            color: #333;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Chess Calendar Admin Panel</h1>
            <p>Manage chess tournament database</p>
        </div>
        
        <!-- Authentication handled via login.html -->
        <div class="auth-section hidden" id="authSection">
            <strong>Authentication Required:</strong>
            <input type="password" id="authToken" placeholder="Enter admin token" onkeypress="if(event.key==='Enter') authenticate()">
            <button class="btn btn-primary" onclick="authenticate()">Authenticate</button>
            <span id="authStatus"></span>
        </div>
        
        <div id="adminContent">
            <div style="background: #d4edda; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                <span>✓ Authenticated successfully</span>
                <button class="btn btn-sm" style="background: #6c757d; color: white;" onclick="logout()">Logout</button>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('view')">View Events</button>
                <button class="tab" onclick="switchTab('add')">Add Event</button>
                <button class="tab" onclick="switchTab('import')">Bulk Import</button>
                <button class="tab" onclick="switchTab('duplicates')">Duplicates</button>
                <button class="tab" onclick="switchTab('backups')">Backups</button>
            </div>
            
            <!-- View Events Tab -->
            <div id="viewTab" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>All Events</h3>
                    <span id="eventCount" style="color: #666; font-size: 14px;"></span>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search events..." onkeyup="searchEvents()">
                    <select id="filterContinent" onchange="filterEvents()">
                        <option value="">All Continents</option>
                        <option value="Europe">Europe</option>
                        <option value="Asia">Asia</option>
                        <option value="Americas">Americas</option>
                        <option value="Africa">Africa</option>
                        <option value="Oceania">Oceania</option>
                    </select>
                    <select id="filterFormat" onchange="filterEvents()">
                        <option value="">All Formats</option>
                        <option value="Classical">Classical</option>
                        <option value="Rapid">Rapid</option>
                        <option value="Blitz">Blitz</option>
                        <option value="Bullet">Bullet</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadEvents()">Refresh</button>
                    <button class="btn btn-success" onclick="downloadCSV(event)">📊 Export CSV</button>
                </div>
                
                <div id="eventsTableContainer"></div>
            </div>
            
            <!-- Add Event Tab -->
            <div id="addTab" class="content-section hidden">
                <form id="addEventForm" onsubmit="addEvent(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Title *</label>
                            <input type="text" name="title" required>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" name="location">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="datetime-local" name="start_datetime">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="datetime-local" name="end_datetime">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>URL *</label>
                            <input type="url" name="url" required>
                        </div>
                        <div class="form-group">
                            <label>Special Event</label>
                            <select name="special">
                                <option value="">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Continent</label>
                            <select name="continent">
                                <option value="">Select...</option>
                                <option value="Europe">Europe</option>
                                <option value="Asia">Asia</option>
                                <option value="Americas">Americas</option>
                                <option value="Africa">Africa</option>
                                <option value="Oceania">Oceania</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Format</label>
                            <select name="format">
                                <option value="">Select...</option>
                                <option value="Classical">Classical</option>
                                <option value="Rapid">Rapid</option>
                                <option value="Blitz">Blitz</option>
                                <option value="Bullet">Bullet</option>
                                <option value="Freestyle">Freestyle</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Event Type</label>
                            <input type="text" name="event_type">
                        </div>
                        <div class="form-group">
                            <label>Rounds</label>
                            <input type="number" name="rounds">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Players</label>
                        <textarea name="players" placeholder="List of notable players"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="description"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Add Event</button>
                </form>
            </div>
            
            <!-- Import Tab -->
            <div id="importTab" class="content-section hidden">
                <h3>Bulk Import from CSV</h3>
                <p>Upload a CSV file with tournament data</p>
                <input type="file" id="csvFile" accept=".csv">
                <button class="btn btn-primary" onclick="importCSV()">Import CSV</button>
                <div id="importResults"></div>
            </div>
            
            <!-- Duplicates Tab -->
            <div id="duplicatesTab" class="content-section hidden">
                <h3>Duplicate Events Management</h3>
                <p>Find and remove duplicate tournament entries based on title, location, and date.</p>
                
                <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>⚠️ Warning:</strong> This will permanently delete duplicate events, keeping only the oldest entry for each duplicate group.
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="findDuplicates()">Find Duplicates</button>
                    <button class="btn btn-danger" id="deleteDuplicatesBtn" onclick="deleteDuplicates()" disabled>Delete All Duplicates</button>
                    <span id="duplicateStats" style="color: #666; margin-left: 10px;"></span>
                </div>
                
                <div id="duplicatesResults">
                    <p style="color: #666;">Click "Find Duplicates" to scan for duplicate events.</p>
                </div>
            </div>
            
            <!-- Backups Tab -->
            <div id="backupsTab" class="content-section hidden">
                <h3>Database Backup & Restore</h3>
                <p>Create, manage, and restore database backups to protect your data.</p>
                
                <div style="background: #d4edda; border: 1px solid #28a745; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>🛡️ Automatic Backups:</strong> Backups are automatically created before destructive operations (like duplicate deletion).
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="createBackup()">Create Manual Backup</button>
                    <button class="btn btn-primary" onclick="loadBackups()">Refresh List</button>
                    <span id="backupStats" style="color: #666; margin-left: 10px;"></span>
                </div>
                
                <div id="backupsResults">
                    <p style="color: #666;">Click "Refresh List" to see available backups.</p>
                </div>
            </div>
        </div>
        
        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Event</h2>
                    <span class="close-modal" onclick="closeEditModal()">&times;</span>
                </div>
                <form id="editEventForm" onsubmit="updateEvent(event)">
                    <input type="hidden" id="editEventId">
                    <!-- Form fields will be populated dynamically -->
                    <div id="editFormFields"></div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Check for authentication on page load
        (function checkAuth() {
            const sessionToken = sessionStorage.getItem('adminAuthToken');
            const localToken = localStorage.getItem('adminAuthToken');
            const tokenExpiry = localStorage.getItem('adminAuthTokenExpiry');
            
            let hasValidToken = false;
            
            if (sessionToken) {
                hasValidToken = true;
            } else if (localToken && tokenExpiry) {
                const now = new Date().getTime();
                if (now < parseInt(tokenExpiry)) {
                    // Token still valid, copy to session
                    sessionStorage.setItem('adminAuthToken', localToken);
                    hasValidToken = true;
                } else {
                    // Token expired, clear it
                    localStorage.removeItem('adminAuthToken');
                    localStorage.removeItem('adminAuthTokenExpiry');
                    localStorage.removeItem('adminUsername');
                }
            }
            
            if (!hasValidToken) {
                // No valid authentication, redirect to login
                window.location.href = '/login.html';
                return;
            }
        })();
        
        let authToken = sessionStorage.getItem('adminAuthToken') || '';
        const API_BASE = window.location.origin;
        let allEvents = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        
        function authenticate() {
            const tokenInput = document.getElementById('authToken').value;
            
            if (!tokenInput) {
                document.getElementById('authStatus').innerHTML = '<span style="color: red;">✗ Please enter a token</span>';
                return;
            }
            
            // Store token in memory and sessionStorage
            authToken = tokenInput;
            sessionStorage.setItem('adminAuthToken', authToken);
            console.log('Authenticating with token:', authToken.substring(0, 10) + '...');
            
            // Test authentication
            fetch(`${API_BASE}/api/events`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('adminContent').classList.remove('hidden');
                    document.getElementById('authStatus').innerHTML = '<span style="color: green;">✓ Authenticated</span>';
                    console.log('Authentication successful');
                    loadEvents();
                } else {
                    document.getElementById('authStatus').innerHTML = '<span style="color: red;">✗ Invalid token. Please try again.</span>';
                    document.getElementById('adminContent').classList.add('hidden');
                    authToken = '';
                    sessionStorage.removeItem('adminAuthToken');
                    console.log('Authentication failed with status:', response.status);
                }
            })
            .catch(error => {
                document.getElementById('authStatus').innerHTML = '<span style="color: red;">✗ Authentication failed: ' + error.message + '</span>';
                document.getElementById('adminContent').classList.add('hidden');
                authToken = '';
                sessionStorage.removeItem('adminAuthToken');
                console.error('Authentication error:', error);
            });
        }
        
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            document.getElementById('viewTab').classList.toggle('hidden', tab !== 'view');
            document.getElementById('addTab').classList.toggle('hidden', tab !== 'add');
            document.getElementById('importTab').classList.toggle('hidden', tab !== 'import');
            document.getElementById('duplicatesTab').classList.toggle('hidden', tab !== 'duplicates');
            document.getElementById('backupsTab').classList.toggle('hidden', tab !== 'backups');
        }
        
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/api/events?limit=2000`);
                const data = await response.json();
                allEvents = data.data || [];
                displayEvents(allEvents);
                
                // Update event count display
                document.getElementById('eventCount').textContent = `Total: ${allEvents.length} events`;
                console.log(`Loaded ${allEvents.length} events`);
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }
        
        function displayEvents(events) {
            const container = document.getElementById('eventsTableContainer');
            
            if (!events || events.length === 0) {
                container.innerHTML = '<p>No events found</p>';
                return;
            }
            
            let html = `
                <table class="events-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortEvents('title')">Title</th>
                            <th class="sortable" onclick="sortEvents('location')">Location</th>
                            <th class="sortable" onclick="sortEvents('start_datetime')">Date</th>
                            <th class="sortable" onclick="sortEvents('format')">Format</th>
                            <th class="sortable" onclick="sortEvents('special')">Special</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            events.forEach(event => {
                const startDate = new Date(event.start_datetime).toLocaleDateString();
                html += `
                    <tr>
                        <td>${event.title}</td>
                        <td>${event.location || '-'}</td>
                        <td>${startDate}</td>
                        <td>${event.format || '-'}</td>
                        <td>${event.special === 'yes' ? '<span class="special-badge">SPECIAL</span>' : ''}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editEvent(${event.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        async function addEvent(e) {
            e.preventDefault();
            
            if (!checkAuth()) return;
            
            const formData = new FormData(e.target);
            const eventData = Object.fromEntries(formData);
            
            // Format datetime
            if (eventData.start_datetime) {
                eventData.start_datetime = eventData.start_datetime.replace('T', ' ') + ':00';
            }
            if (eventData.end_datetime) {
                eventData.end_datetime = eventData.end_datetime.replace('T', ' ') + ':00';
            }
            
            // Always use the latest token from sessionStorage
            const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
            if (!currentToken) {
                alert('No authentication token found. Please authenticate again.');
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('adminContent').classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(eventData)
                });
                
                if (response.ok) {
                    alert('Event added successfully!');
                    e.target.reset();
                    switchTab('view');
                    loadEvents();
                } else {
                    const error = await response.json();
                    if (response.status === 401) {
                        alert('Authentication required! Please enter the admin token at the top of the page.\n\nDefault token: your-secret-admin-token-2025');
                        document.getElementById('authSection').classList.remove('hidden');
                        document.getElementById('adminContent').classList.add('hidden');
                    } else {
                        alert('Error: ' + error.error);
                    }
                }
            } catch (error) {
                alert('Error adding event: ' + error.message);
            }
        }
        
        async function editEvent(id) {
            if (!checkAuth()) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/events/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                const event = data.data;
                
                document.getElementById('editEventId').value = id;
                
                // Populate edit form
                const fields = `
                    <div class="form-row">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" name="title" value="${event.title}" required>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" name="location" value="${event.location || ''}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>URL</label>
                            <input type="url" name="url" value="${event.url}" required>
                        </div>
                        <div class="form-group">
                            <label>Special</label>
                            <select name="special">
                                <option value="" ${event.special !== 'yes' ? 'selected' : ''}>No</option>
                                <option value="yes" ${event.special === 'yes' ? 'selected' : ''}>Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Players</label>
                        <textarea name="players">${event.players || ''}</textarea>
                    </div>
                `;
                
                document.getElementById('editFormFields').innerHTML = fields;
                document.getElementById('editModal').style.display = 'block';
                
            } catch (error) {
                alert('Error loading event: ' + error.message);
            }
        }
        
        async function updateEvent(e) {
            e.preventDefault();
            
            if (!checkAuth()) return;
            
            const id = document.getElementById('editEventId').value;
            const formData = new FormData(e.target);
            const eventData = Object.fromEntries(formData);
            
            // Always use the latest token from sessionStorage
            const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
            if (!currentToken) {
                alert('No authentication token found. Please authenticate again.');
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('adminContent').classList.add('hidden');
                return;
            }
            
            console.log('Updating event with token:', currentToken ? currentToken.substring(0, 10) + '...' : 'NO TOKEN');
            
            try {
                const response = await fetch(`${API_BASE}/api/events/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(eventData)
                });
                
                if (response.ok) {
                    alert('Event updated successfully!');
                    closeEditModal();
                    loadEvents();
                } else {
                    const error = await response.json();
                    if (response.status === 401) {
                        console.error('Update auth failed - token being used:', authToken ? authToken.substring(0, 10) + '...' : 'NO TOKEN');
                        alert('Authentication error! The token might be incorrect. Please check your token:\n\nDefault: your-secret-admin-token-2025\n\nIf using a custom token, make sure it matches the ADMIN_TOKEN environment variable.');
                        // Don't automatically clear the session
                    } else {
                        alert('Error: ' + error.error);
                    }
                }
            } catch (error) {
                alert('Error updating event: ' + error.message);
            }
        }
        
        async function deleteEvent(id) {
            if (!checkAuth()) return;
            
            if (!confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            // Always use the latest token from sessionStorage
            const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
            if (!currentToken) {
                alert('No authentication token found. Please authenticate again.');
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('adminContent').classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/events/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    alert('Event deleted successfully!');
                    loadEvents();
                } else {
                    const error = await response.json();
                    if (response.status === 401) {
                        alert('Authentication error! Your session may have expired. Please refresh the page and authenticate again.');
                        document.getElementById('authSection').classList.remove('hidden');
                        document.getElementById('adminContent').classList.add('hidden');
                        authToken = '';
                        sessionStorage.removeItem('adminAuthToken');
                    } else {
                        alert('Error: ' + error.error);
                    }
                }
            } catch (error) {
                alert('Error deleting event: ' + error.message);
            }
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        function searchEvents() {
            // Implement search functionality
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.events-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function filterEvents() {
            // Implement filter functionality
            loadEvents(); // For now, just reload
        }
        
        function sortEvents(column) {
            // Determine sort direction
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Sort the events
            const sortedEvents = [...allEvents].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle null/undefined values
                if (aVal === null || aVal === undefined || aVal === '') aVal = '';
                if (bVal === null || bVal === undefined || bVal === '') bVal = '';
                
                // Special handling for dates
                if (column === 'start_datetime' || column === 'end_datetime') {
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                }
                
                // Convert to lowercase for string comparison
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                
                // Compare values
                if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Update display
            displayEvents(sortedEvents);
            
            // Update header styles
            updateSortHeaders(column);
        }
        
        function updateSortHeaders(column) {
            // Remove all sort classes
            document.querySelectorAll('.events-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add appropriate sort class to the active column
            const headers = document.querySelectorAll('.events-table th');
            headers.forEach(th => {
                if (th.textContent === column || 
                    (column === 'title' && th.textContent === 'Title') ||
                    (column === 'location' && th.textContent === 'Location') ||
                    (column === 'start_datetime' && th.textContent === 'Date') ||
                    (column === 'format' && th.textContent === 'Format') ||
                    (column === 'special' && th.textContent === 'Special')) {
                    th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        // Page initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Load events on page load since user is already authenticated
            loadEvents();
        });
        
        // Prevent right-click inspect element bypass
        function checkAuth() {
            if (!authToken) {
                document.getElementById('adminContent').classList.add('hidden');
                document.getElementById('authSection').classList.remove('hidden');
                alert('Session expired. Please authenticate again.');
                return false;
            }
            return true;
        }
        
        // Logout function
        function logout() {
            authToken = '';
            sessionStorage.removeItem('adminAuthToken');
            localStorage.removeItem('adminAuthToken');
            localStorage.removeItem('adminAuthTokenExpiry');
            alert('Logged out successfully');
            window.location.href = '/login.html';
        }
        
        // CSV Import function
        async function importCSV() {
            if (!checkAuth()) return;
            
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const csvText = e.target.result;
                const events = parseCSV(csvText);
                
                if (events.length === 0) {
                    alert('No valid events found in CSV');
                    return;
                }
                
                document.getElementById('importResults').innerHTML = `<p>Processing ${events.length} events...</p>`;
                
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                if (!currentToken) {
                    alert('No authentication token found. Please authenticate again.');
                    return;
                }
                
                // Process events
                for (const event of events) {
                    try {
                        // Map CSV columns to API fields
                        const eventData = {
                            title: event.Name || event.title || 'Untitled Event',
                            location: event.Location || event.location || '',
                            url: event.URL || event.url || '',
                            event_type: event.Type || event.event_type || '',
                            format: event.Format || event.format || '',
                            continent: event.Continent || event.continent || '',
                            players: event.Players || event.players || '',
                            description: event.Description || event.description || '',
                            prize_fund: event['Prize Fund'] || event.prize_fund || '',
                            special: event.Special || event.special || '',
                            live_games: event['Live games'] || event.live_games || '',
                            landing: event.Landing || event.landing || ''
                        };
                        
                        // Parse dates
                        const startDate = parseDate(event['Start date'] || event.start_date);
                        const endDate = parseDate(event['End date'] || event.end_date);
                        
                        if (!startDate) {
                            throw new Error(`Invalid start date for "${eventData.title}"`);
                        }
                        
                        if (!eventData.url) {
                            throw new Error(`Missing URL for "${eventData.title}"`);
                        }
                        
                        eventData.start_datetime = startDate + ' 00:00:00';
                        eventData.end_datetime = (endDate || startDate) + ' 00:00:00';
                        
                        // Parse rounds
                        if (event.Rounds || event.rounds) {
                            eventData.rounds = parseInt(event.Rounds || event.rounds);
                        }
                        
                        // Send to API
                        const response = await fetch(`${API_BASE}/api/events`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentToken}`
                            },
                            body: JSON.stringify(eventData)
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            throw new Error('API error');
                        }
                    } catch (error) {
                        errorCount++;
                        errors.push(`${event.Name || event.title}: ${error.message}`);
                    }
                }
                
                // Show results
                let message = `Import complete! Successfully added ${successCount} events.`;
                if (errorCount > 0) {
                    message += ` Failed: ${errorCount} events.`;
                    if (errors.length <= 5) {
                        message += '<br>Errors:<br>' + errors.join('<br>');
                    }
                }
                
                document.getElementById('importResults').innerHTML = `<div class="success-message">${message}</div>`;
                
                if (successCount > 0) {
                    loadEvents();
                    fileInput.value = '';
                }
            };
            
            reader.readAsText(file);
        }
        
        // Parse CSV text to array of objects
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            // Get headers and normalize them
            const headers = lines[0].split(',').map(h => h.trim());
            const events = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                // Parse CSV line handling quoted values
                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                // Create event object
                const event = {};
                headers.forEach((header, index) => {
                    event[header] = values[index] || '';
                });
                
                if (event.Name || event.title) {
                    events.push(event);
                }
            }
            
            return events;
        }
        
        // Parse date from various formats
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Handle dates like "January 2" by adding current or next year
            const months = {
                'January': '01', 'February': '02', 'March': '03', 'April': '04',
                'May': '05', 'June': '06', 'July': '07', 'August': '08',
                'September': '09', 'October': '10', 'November': '11', 'December': '12'
            };
            
            // Match patterns like "January 2" or "January 10"
            const match = dateStr.match(/^(\w+)\s+(\d+)$/);
            if (match) {
                const month = months[match[1]];
                const day = match[2].padStart(2, '0');
                if (month) {
                    const currentYear = new Date().getFullYear();
                    return `${currentYear}-${month}-${day}`;
                }
            }
            
            // Try parsing as standard date
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
            } catch (e) {}
            
            return null;
        }
        
        // Duplicate management functions
        async function findDuplicates() {
            if (!checkAuth()) return;
            
            try {
                document.getElementById('duplicatesResults').innerHTML = '<p>Searching for duplicates...</p>';
                
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                const response = await fetch(`${API_BASE}/api/duplicates`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch duplicates');
                }
                
                const data = await response.json();
                displayDuplicates(data);
                
            } catch (error) {
                document.getElementById('duplicatesResults').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }
        
        function displayDuplicates(data) {
            const container = document.getElementById('duplicatesResults');
            const stats = document.getElementById('duplicateStats');
            const deleteBtn = document.getElementById('deleteDuplicatesBtn');
            
            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div class="success-message">✅ No duplicates found! Your database is clean.</div>';
                stats.textContent = '';
                deleteBtn.disabled = true;
                return;
            }
            
            stats.textContent = `Found ${data.total} duplicate groups affecting ${data.totalDuplicates} events`;
            deleteBtn.disabled = false;
            
            let html = '<h4>Duplicate Events Found:</h4>';
            
            data.data.forEach(group => {
                html += `
                    <div style="border: 1px solid #ddd; margin-bottom: 15px; border-radius: 6px; overflow: hidden;">
                        <div style="background: #f8f9fa; padding: 10px; border-bottom: 1px solid #ddd;">
                            <strong>${group.title}</strong><br>
                            <small>📍 ${group.location} | 📅 ${new Date(group.start_datetime).toLocaleDateString()}</small>
                            <span style="float: right; background: #ffc107; color: #333; padding: 2px 8px; border-radius: 3px; font-size: 12px;">
                                ${group.count} duplicates
                            </span>
                        </div>
                        <div style="padding: 10px;">
                            <table style="width: 100%; font-size: 13px;">
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding: 5px;">ID</th>
                                        <th style="text-align: left; padding: 5px;">Created</th>
                                        <th style="text-align: left; padding: 5px;">URL</th>
                                        <th style="text-align: left; padding: 5px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                group.events.forEach((event, index) => {
                    const isKeeping = index === 0; // Keep the first (oldest) one
                    html += `
                        <tr style="background: ${isKeeping ? '#d4edda' : '#f8d7da'};">
                            <td style="padding: 5px;">${event.id}</td>
                            <td style="padding: 5px;">${new Date(event.created_at).toLocaleDateString()}</td>
                            <td style="padding: 5px;"><a href="${event.url}" target="_blank" style="font-size: 11px;">Link</a></td>
                            <td style="padding: 5px; font-weight: bold; color: ${isKeeping ? '#155724' : '#721c24'};">
                                ${isKeeping ? '✅ KEEP (oldest)' : '🗑️ DELETE'}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function deleteDuplicates() {
            if (!checkAuth()) return;
            
            if (!confirm('Are you sure you want to delete all duplicate events? This action cannot be undone.\n\nThis will keep the oldest entry for each duplicate group and delete the rest.')) {
                return;
            }
            
            try {
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                const response = await fetch(`${API_BASE}/api/duplicates/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ mode: 'auto' })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete duplicates');
                }
                
                const result = await response.json();
                
                document.getElementById('duplicatesResults').innerHTML = `
                    <div class="success-message">
                        ✅ ${result.message}
                    </div>
                `;
                
                document.getElementById('duplicateStats').textContent = '';
                document.getElementById('deleteDuplicatesBtn').disabled = true;
                
                // Refresh the main events list if we're on the view tab
                loadEvents();
                
            } catch (error) {
                document.getElementById('duplicatesResults').innerHTML = `
                    <div class="error-message">Error deleting duplicates: ${error.message}</div>
                `;
            }
        }
        
        // Backup management functions
        async function loadBackups() {
            if (!checkAuth()) return;
            
            try {
                document.getElementById('backupsResults').innerHTML = '<p>Loading backups...</p>';
                
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                const response = await fetch(`${API_BASE}/api/backups`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch backups');
                }
                
                const data = await response.json();
                displayBackups(data);
                
            } catch (error) {
                document.getElementById('backupsResults').innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
            }
        }
        
        function displayBackups(data) {
            const container = document.getElementById('backupsResults');
            const stats = document.getElementById('backupStats');
            
            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div style="color: #666;">No backups found. Create your first backup to protect your data!</div>';
                stats.textContent = '';
                return;
            }
            
            stats.textContent = `Total backups: ${data.total}`;
            
            let html = '<h4>Available Backups:</h4>';
            html += `
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Created</th>
                            <th>Reason</th>
                            <th>Events</th>
                            <th>Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.data.forEach(backup => {
                const date = new Date(backup.timestamp).toLocaleString();
                const size = formatFileSize(backup.backupSize);
                const reason = backup.reason.replace('-', ' ').toUpperCase();
                
                html += `
                    <tr>
                        <td>${date}</td>
                        <td>
                            <span style="background: ${getReasonColor(backup.reason)}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px;">
                                ${reason}
                            </span>
                        </td>
                        <td>${backup.eventCount}</td>
                        <td>${size}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="restoreBackup('${backup.filename}')">Restore</button>
                            <button class="btn btn-primary btn-sm" onclick="downloadBackup('${backup.filename}')">Download</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backup.filename}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function getReasonColor(reason) {
            const colors = {
                'manual': '#007bff',
                'duplicate-deletion': '#dc3545', 
                'pre-restore': '#6c757d',
                'import': '#28a745'
            };
            return colors[reason] || '#6c757d';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        async function createBackup() {
            if (!checkAuth()) return;
            
            try {
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                const response = await fetch(`${API_BASE}/api/backups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ reason: 'manual' })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create backup');
                }
                
                const result = await response.json();
                
                document.getElementById('backupsResults').innerHTML = `
                    <div class="success-message">
                        ✅ ${result.message}<br>
                        <strong>Backup:</strong> ${result.backup}
                    </div>
                `;
                
                // Refresh the backup list after a short delay
                setTimeout(() => {
                    loadBackups();
                }, 1000);
                
            } catch (error) {
                document.getElementById('backupsResults').innerHTML = `
                    <div class="error-message">Error creating backup: ${error.message}</div>
                `;
            }
        }
        
        async function restoreBackup(filename) {
            if (!checkAuth()) return;
            
            if (!confirm(`Are you sure you want to restore from backup "${filename}"?\\n\\nThis will replace the current database with the backup data. A backup of the current state will be created automatically.\\n\\nWARNING: The server will need to be restarted after restoration.`)) {
                return;
            }
            
            try {
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                const response = await fetch(`${API_BASE}/api/backups/${filename}/restore`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to restore backup');
                }
                
                const result = await response.json();
                
                document.getElementById('backupsResults').innerHTML = `
                    <div class="success-message">
                        ✅ ${result.message}<br>
                        <strong>Pre-restore backup:</strong> ${result.preRestoreBackup}<br><br>
                        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <strong>⚠️ ${result.warning}</strong>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('backupsResults').innerHTML = `
                    <div class="error-message">Error restoring backup: ${error.message}</div>
                `;
            }
        }
        
        async function downloadBackup(filename) {
            if (!checkAuth()) return;
            
            try {
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                const url = `${API_BASE}/api/backups/${filename}/download?token=${encodeURIComponent(currentToken)}`;
                
                // Create a temporary link to trigger download
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                // Set authorization header (though this might not work for downloads)
                const response = await fetch(`${API_BASE}/api/backups/${filename}/download`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    link.href = downloadUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);
                } else {
                    throw new Error('Failed to download backup');
                }
                
            } catch (error) {
                alert(`Error downloading backup: ${error.message}`);
            }
        }
        
        async function deleteBackup(filename) {
            if (!checkAuth()) return;
            
            if (!confirm(`Are you sure you want to delete backup "${filename}"?\\n\\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                const response = await fetch(`${API_BASE}/api/backups/${filename}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete backup');
                }
                
                const result = await response.json();
                
                // Show success message and refresh list
                document.getElementById('backupsResults').innerHTML = `
                    <div class="success-message">✅ ${result.message}</div>
                `;
                
                setTimeout(() => {
                    loadBackups();
                }, 1000);
                
            } catch (error) {
                document.getElementById('backupsResults').innerHTML = `
                    <div class="error-message">Error deleting backup: ${error.message}</div>
                `;
            }
        }
        
        // CSV Export function
        async function downloadCSV(event) {
            if (!checkAuth()) return;
            
            try {
                const currentToken = sessionStorage.getItem('adminAuthToken') || authToken;
                
                // Show loading message
                const originalButton = event ? event.target : document.querySelector('button[onclick*="downloadCSV"]');
                const originalText = originalButton.innerHTML;
                originalButton.innerHTML = '⏳ Exporting...';
                originalButton.disabled = true;
                
                const response = await fetch(`${API_BASE}/api/export/csv`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to export CSV');
                }
                
                // Get filename from response headers
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'calendar_events.csv';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="([^"]+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up
                window.URL.revokeObjectURL(url);
                
                // Show success message briefly
                originalButton.innerHTML = '✅ Downloaded!';
                setTimeout(() => {
                    originalButton.innerHTML = originalText;
                    originalButton.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error downloading CSV:', error);
                alert(`Error exporting CSV: ${error.message}`);
                
                // Reset button
                const button = event ? event.target : document.querySelector('button[onclick*="downloadCSV"]');
                if (button) {
                    button.innerHTML = '📊 Export CSV';
                    button.disabled = false;
                }
            }
        }
        
    </script>
</body>
</html>